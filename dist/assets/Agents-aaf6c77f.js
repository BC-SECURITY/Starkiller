import{_ as y}from"./AgentTasksList-f6ba31e5.js";import{_ as A}from"./TagViewer-81c3b950.js";import{_ as d}from"./DateTimeDisplay-951c60c5.js";import{h as x}from"./moment-fbc5633a.js";import{n as g,C as S,u as b,D as C,E,F,G as L,k as p,a as l,b as r,d as h,e as i,H as f,i as u,c as _,f as o}from"./index-e409ba63.js";import{_ as D}from"./VDataTable-dab2ebf1.js";import{_ as P}from"./VTooltip-7c0b187f.js";import{_ as T}from"./ExpansionPanelFilter-010a2264.js";import{_ as $}from"./AdvancedTable-e51651be.js";import{_ as w}from"./ListPageTop-78cbc2f3.js";import{g as M}from"./tag-api-d7e45ad4.js";import{_ as m}from"./VSwitch-3f004360.js";import{_ as R,a as v,b as q,c as k}from"./VTabItem-01f057dc.js";import"./TooltipButton-f53c45a7.js";import"./index-e87896eb.js";import"./ansi_up-7c0d87a9.js";import"./download-stager-ae353708.js";import"./VPagination-4794e169.js";import"./ExpansionPanelSearch-94b8e3ac.js";import"./VExpansionPanelHeader-69136628.js";import"./VSelect-22e7980f.js";import"./VExpansionPanels-cacfd68a.js";import"./VItemGroup-3637266a.js";const K={name:"AgentsTable",components:{DateTimeDisplay:d,TagViewer:A},props:{input:{type:Array,default:()=>[]},selectedTags:{type:Array,default:()=>[]},hideStaleAgents:{type:Boolean,required:!0},hideArchivedAgents:{type:Boolean,required:!0},refreshAgents:{type:Boolean,default:!1}},data(){return{loading:!1,headersFull:[{text:"Name",value:"name",defaultHeader:!0,alwaysShow:!0,order:1},{text:"Last Seen",value:"lastseen_time",defaultHeader:!0,alwaysShow:!0,order:2},{text:"First Seen",value:"checkin_time",defaultHeader:!0,alwaysShow:!0,order:3},{text:"Listener",value:"listener",order:4},{text:"Hostname",value:"hostname",defaultHeader:!0,order:5},{text:"Process",value:"process_name",defaultHeader:!0,order:6},{text:"Process ID",value:"process_id",order:7},{text:"Architecture",value:"architecture",order:8},{text:"Language",value:"language",defaultHeader:!0,order:9},{text:"Language Version",value:"language_version",order:10},{text:"Username",value:"username",defaultHeader:!0,order:11},{text:"Working Hours",value:"working_hours",order:12},{text:"External IP",value:"external_ip",order:13},{text:"Internal IP",value:"internal_ip",defaultHeader:!0,order:14},{text:"Delay",value:"delay",order:15},{text:"Jitter",value:"jitter",order:16},{text:"Tags",value:"tags",order:17},{text:"Actions",value:"actions",defaultHeader:!0,alwaysShow:!0,order:18}],selectedHeadersTemp:[],selected:[],showHeaderMenu:!1,refreshInterval:null,moment:x}},computed:{agentStore(){return S()},applicationStore(){return b()},agents(){return this.agentStore.agents},agentsStatus(){return this.agentStore.status},selectedAll:{set(s){this.selectedHeadersTemp=[...this.staticHeaders],s&&this.headersFull.forEach(e=>{this.selectedHeadersTemp.push(e)})},get(){return this.selectedHeadersTemp.length===this.count}},headers(){return this.headersFull.filter(s=>this.applicationStore.agentHeaders.findIndex(e=>e.text===s.text)>-1).sort((s,e)=>s.order-e.order)},selectableHeaders(){return this.headersFull.filter(s=>!s.alwaysShow)},staticHeaders(){return this.headersFull.filter(s=>s.alwaysShow)},sortedAgents(){let s=this.agents.slice();return s.sort((e,t)=>e.checkin_time.localeCompare(t.checkin_time)),this.hideStaleAgents&&(s=s.filter(e=>!e.stale)),this.hideArchivedAgents&&(s=s.filter(e=>!e.archived)),this.selectedTags.length===0||(s=s.filter(e=>e.tags.map(a=>`${a.name}:${a.value}`).some(a=>this.selectedTags.includes(a)))),s}},watch:{selectedTags(){this.getAgents()},selected(s){this.$emit("input",s)},refreshAgents:{handler(s){s?(this.getAgents(),this.refreshInterval=setInterval(()=>{this.getAgents()},8e3)):(console.log("Clearing interval"),clearInterval(this.refreshInterval))},immediate:!0}},beforeDestroy(){clearInterval(this.refreshInterval)},async mounted(){this.getAgents(),this.applicationStore.agentHeaders.length===0&&(this.applicationStore.agentHeaders=this.headersFull.filter(s=>s.defaultHeader===!0)),this.selectedHeadersTemp=[...this.applicationStore.agentHeaders]},methods:{deleteTag(s,e){C(s.session_id,e.id).then(()=>{s.tags=s.tags.filter(t=>t.id!==e.id),this.$emit("refresh-tags")}).catch(t=>this.$snack.error(`Error: ${t}`))},updateTag(s,e){E(s.session_id,e).then(t=>{const a=s.tags.findIndex(n=>n.id===t.id);s.tags.splice(a,1,t),this.$emit("refresh-tags"),this.$snack.success("Tag updated")}).catch(t=>this.$snack.error(`Error: ${t}`))},addTag(s,e){F(s.session_id,e).then(t=>{s.tags.push(t),this.$emit("refresh-tags")}).catch(t=>this.$snack.error(`Error: ${t}`))},submitHeaderForm(){this.applicationStore.agentHeaders=[...this.selectedHeadersTemp],this.showHeaderMenu=!1},getAgents(){this.agentStore.getAgents()},async reloadSysInfo(s){try{await L(s.session_id),this.$snack.success(`SysInfo reload queued for ${s.name}`)}catch(e){this.$snack.error(`Error reloading SysInfo for ${s.name}: ${e.message}`)}},async killAgent(s){this.$emit("kill-agent",s)},popout(s){window.open(`${window.location.href}/${s.name}?hideSideBar=true`,"popup","width=600,height=600")},truncateMessage(s){return s?s.length>30?`${s.substr(0,30)}...`:s:""},rowClass(s){return s.stale?"warning-row":""}}};var B=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"ml-3 mr-3 align-center",staticStyle:{display:"flex","flex-direction":"row-reverse"}},[t("div",{staticStyle:{height:"40px"}}),t(p,{attrs:{"offset-y":"","close-on-content-click":!1},scopedSlots:e._u([{key:"activator",fn:function({on:a,attrs:n}){return[t(l,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",n,!1),a),[t(r,[e._v("mdi-format-columns")])],1)]}}]),model:{value:e.showHeaderMenu,callback:function(a){e.showHeaderMenu=a},expression:"showHeaderMenu"}},[t(h,{staticStyle:{"overflow-y":"auto"},attrs:{"max-height":"400px"}},[t(i,[t(f,{attrs:{label:"Select All"},model:{value:e.selectedAll,callback:function(a){e.selectedAll=a},expression:"selectedAll"}})],1),t(u,{staticClass:"pb-4"}),e._l(e.selectableHeaders,function(a,n){return t(i,{key:n},[t(f,{attrs:{label:a.text,value:a},model:{value:e.selectedHeadersTemp,callback:function(c){e.selectedHeadersTemp=c},expression:"selectedHeadersTemp"}})],1)})],2),t(_,{staticClass:"pt-4"},[t(l,{staticClass:"mb-4",attrs:{text:""},on:{click:function(a){e.showHeaderMenu=!1}}},[e._v(" Cancel ")]),t(l,{staticClass:"ml-4 mb-4",attrs:{text:""},on:{click:e.submitHeaderForm}},[e._v(" Save ")])],1)],1)],1),t(D,{attrs:{loading:e.agentsStatus==="loading","item-class":e.rowClass,headers:e.headers,items:e.sortedAgents,"footer-props":{itemsPerPageOptions:[5,10,15,20,50,100]},"items-per-page":15,"item-key":"session_id",dense:"","show-select":""},scopedSlots:e._u([{key:"item.name",fn:function({item:a}){return[t(P,{attrs:{top:""},scopedSlots:e._u([{key:"activator",fn:function({on:n}){return[a.high_integrity?t(r,e._g({attrs:{small:""}},n),[e._v(" fa-user-cog ")]):e._e()]}}],null,!0)},[t("span",[e._v("Elevated Process")])]),t("router-link",{staticStyle:{color:"inherit"},attrs:{to:{name:"agentEdit",params:{id:a.session_id}}}},[e._v(" "+e._s(a.name)+" ")])]}},{key:"item.lastseen_time",fn:function({item:a}){return[t(d,{attrs:{timestamp:a.lastseen_time}})]}},{key:"item.checkin_time",fn:function({item:a}){return[t(d,{attrs:{timestamp:a.checkin_time}})]}},{key:"item.listener",fn:function({item:a}){return[t("router-link",{staticStyle:{color:"inherit"},attrs:{to:{name:"listenerEdit",params:{id:a.listener}}}},[e._v(" "+e._s(a.listener)+" ")])]}},{key:"item.process_name",fn:function({item:a}){return[t("span",[e._v(e._s(e.truncateMessage(a.process_name)))])]}},{key:"item.tags",fn:function({item:a}){return[t(A,{attrs:{tags:a.tags},on:{"update-tag":function(n){return e.updateTag(a,...arguments)},"delete-tag":function(n){return e.deleteTag(a,...arguments)},"new-tag":function(n){return e.addTag(a,...arguments)}}})]}},{key:"item.actions",fn:function({item:a}){return[t(p,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:n,attrs:c}){return[t(l,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",c,!1),n),[t(r,[e._v("fa-ellipsis-v")])],1)]}}],null,!0)},[t(h,{staticClass:"ml-2 mr-2"},[t(i,{key:"view",attrs:{link:""}},[t("router-link",{staticClass:"text-decoration-none",staticStyle:{color:"inherit"},attrs:{to:{name:"agentEdit",params:{id:a.session_id}}}},[t(o,[t(r,[e._v("fa-binoculars")]),e._v(" View ")],1)],1)],1),t(i,{key:"popout",attrs:{link:""},on:{click:function(n){return e.popout(a)}}},[t(o,[t(r,[e._v(" fa-external-link-alt ")]),e._v(" Popout ")],1)],1),t(u,{staticClass:"pb-4"}),t(i,{on:{click:function(n){return e.reloadSysInfo(a)}}},[t(o,[t(r,[e._v("fa-sync")]),e._v(" Reload SysInfo ")],1)],1),t(u,{staticClass:"pb-4"}),t(i,{key:"delete",attrs:{link:""},on:{click:function(n){return e.killAgent(a)}}},[t(o,[t(r,[e._v("fa-trash-alt")]),e._v(" Kill ")],1)],1)],1)],1)]}}]),model:{value:e.selected,callback:function(a){e.selected=a},expression:"selected"}})],1)},V=[],X=g(K,B,V,!1,null,"b55092d8",null,null);const H=X.exports;const j={name:"AgentsList",components:{AdvancedTable:$,ExpansionPanelFilter:T,AgentsTable:H,ListPageTop:w},props:{active:{type:Boolean,default:!1}},data(){return{breads:[{text:"Agents",disabled:!0,href:"/agents"},{text:"List",disabled:!0,href:"/agents?tab=list-view"}],selected:[],selectedTags:[],tags:[],moment:x,autoRefresh:!0}},computed:{agentStore(){return S()},applicationStore(){return b()},agents(){return this.agentStore.agents},sortedAgents(){let s=this.agents.slice();return s.sort((e,t)=>-e.lastseen_time.localeCompare(t.lastseen_time)),this.hideStaleAgents&&(s=s.filter(e=>!e.stale)),this.hideArchivedAgents&&(s=s.filter(e=>!e.archived)),this.selectedTags.length===0||(s=s.filter(e=>e.tags.map(a=>`${a.name}:${a.value}`).some(a=>this.selectedTags.includes(a)))),s},showDelete(){return this.selected.length>0}},async mounted(){this.getTags()},methods:{async getTags(){const s=await M({page:1,limit:-1,sources:"agent"}),e=[];s.records.forEach(t=>{e.find(n=>n.name===t.name&&n.value===t.value)||e.push(t)}),this.tags=e},async killAgents(){await this.$root.$confirm("Kill Agent",`Do you want to kill ${this.selected.length} agents?`,{color:"red"})&&(this.selected.forEach(s=>{this.agentStore.killAgent({sessionId:s.session_id})}),this.$snack.success(`${this.selected.length} agents tasked to run TASK_EXIT.`),this.selected=[])},getAgents(){this.$refs.agentsTable.getAgents()},async killAgent(s){await this.$root.$confirm("Kill Agent",`Do you want to kill agent ${s.name}?`,{color:"red"})&&(this.agentStore.killAgent({sessionId:s.session_id}),this.$snack.success(`Agent ${s.name} tasked to run TASK_EXIT.`))}}};var z=function(){var e=this,t=e._self._c;return t("div",[e.active?t(w,{attrs:{breads:e.breads,"show-create":!1,"show-refresh":!0,"show-delete":e.showDelete,"is-auto-refresh":!0,"auto-refresh":e.autoRefresh,"refresh-text":"Auto-refresh Agents","delete-text":"Kill"},on:{"update:auto-refresh":function(a){e.autoRefresh=a},delete:e.killAgents,refresh:e.getAgents}}):e._e(),t($,{scopedSlots:e._u([{key:"filters",fn:function(){return[t(m,{attrs:{label:"Hide Stale Agents"},model:{value:e.applicationStore.hideStaleAgents,callback:function(a){e.$set(e.applicationStore,"hideStaleAgents",a)},expression:"applicationStore.hideStaleAgents"}}),t(m,{staticClass:"pl-4",attrs:{label:"Hide Archived Agents"},model:{value:e.applicationStore.hideArchivedAgents,callback:function(a){e.$set(e.applicationStore,"hideArchivedAgents",a)},expression:"applicationStore.hideArchivedAgents"}}),t(T,{attrs:{title:"Tags",label:"label","item-key":"id","item-value":"label",items:e.tags,"empty-default":!0},model:{value:e.selectedTags,callback:function(a){e.selectedTags=a},expression:"selectedTags"}})]},proxy:!0},{key:"table",fn:function(){return[t(H,{ref:"agentsTable",attrs:{"hide-stale-agents":e.applicationStore.hideStaleAgents,"hide-archived-agents":e.applicationStore.hideArchivedAgents,"selected-tags":e.selectedTags,"refresh-agents":e.autoRefresh},on:{"refresh-tags":e.getTags,"kill-agent":e.killAgent},model:{value:e.selected,callback:function(a){e.selected=a},expression:"selected"}})]},proxy:!0}])})],1)},G=[],J=g(j,z,G,!1,null,"dd532cc3",null,null);const I=J.exports;const N={name:"Agents",components:{AgentsList:I,AgentTasksList:y},data(){return{}},computed:{tab:{set(s){this.$router.replace({query:{...this.$route.query,tab:s}})},get(){return this.$route.query.tab||"list-view"}}}};var O=function(){var e=this,t=e._self._c;return t("div",[t("portal",{attrs:{to:"app-bar-extension"}},[t("div",{staticStyle:{display:"flex","flex-direction":"row",width:"100%"}},[t(R,{attrs:{"align-with-title":""},model:{value:e.tab,callback:function(a){e.tab=a},expression:"tab"}},[t(v,{key:"list-view",attrs:{href:"#list-view"}},[e._v(" List "),t(r,{staticClass:"ml-1",attrs:{"x-small":""}},[e._v(" fa-list ")])],1),t(v,{key:"tasks",attrs:{href:"#tasks"}},[e._v(" Tasks "),t(r,{staticClass:"ml-1",attrs:{"x-small":""}},[e._v(" fa-sticky-note ")])],1)],1)],1)]),t(q,{model:{value:e.tab,callback:function(a){e.tab=a},expression:"tab"}},[t(k,{key:"list-view",attrs:{value:"list-view",transition:!1,"reverse-transition":!1}},[t(_,{attrs:{flat:""}},[t(I,{attrs:{active:e.tab==="list-view"}})],1)],1),t(k,{key:"tasks",attrs:{value:"tasks",transition:!1,"reverse-transition":!1}},[t(_,{attrs:{flat:""}},[t(y,{attrs:{active:e.tab==="tasks","use-header":!0}})],1)],1)],1)],1)},U=[],W=g(N,O,U,!1,null,null,null,null);const ye=W.exports;export{ye as default};
