import{_ as d}from"./TagViewer-fb73600c.js";import{_ as r}from"./DateTimeDisplay-ce5a474a.js";import{_ as i}from"./ExpansionPanelFilter-0b03a2e3.js";import{_ as u}from"./ExpansionPanelSearch-510739da.js";import{_ as g}from"./TooltipButton-62ba9662.js";import{_ as p}from"./ListPageTop-e87eaf4c.js";import{n as m,az as _,aA as h,aB as f,aC as v,x as b,aD as w,c as l,k as y,a as x,b as c,d as P,a2 as T,e as D,f as k}from"./index-1a1ed2d6.js";import{d as B}from"./index-28064a6a.js";import{h as S}from"./moment-fbc5633a.js";import{g as $}from"./tag-api-aa620703.js";import{_ as F}from"./VExpansionPanels-772758bb.js";import{_ as C}from"./VPagination-2a8301ed.js";import{_ as G}from"./VDataTable-f82f592f.js";import"./VSelect-8447b5da.js";import"./VTooltip-90e9ddba.js";import"./VExpansionPanelHeader-6964ad73.js";import"./VItemGroup-d98abd29.js";const E={name:"Downloads",components:{DateTimeDisplay:r,ExpansionPanelSearch:u,ExpansionPanelFilter:i,TagViewer:d,ListPageTop:p,TooltipButton:g},data(){return{moment:S,items:[],currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10,sortBy:"updated_at",sortDesc:!0,loading:!1,search:"",breads:[{text:"Downloads",disabled:!0,href:"/downloads"}],headers:[{text:"Id",value:"id",sortable:!1},{text:"Filename",value:"filename",sortable:!0},{text:"Location",value:"location",sortable:!0},{text:"Size",value:"size",sortable:!0},{text:"Created At",value:"created_at",sortable:!0},{text:"Updated At",value:"updated_at",sortable:!0},{text:"Tags",value:"tags",sortable:!1},{text:"Actions",value:"actions",sortable:!1}],isSelecting:!1,selectedFile:null,selectedSources:[],sources:[{label:"Upload",value:"upload"},{label:"Agent Task",value:"agent_task"},{label:"Agent File",value:"agent_file"},{label:"Stager",value:"stager"}],selectedTags:[],tags:[],debouncedGetDownloads:B(this.getDownloads,500)}},watch:{search(){this.debouncedGetDownloads()},selectedSources(){this.debouncedGetDownloads()},selectedTags(){this.debouncedGetDownloads()}},async mounted(){this.selectedSources=this.sources.map(s=>s.value),this.getTags(),this.getDownloads()},methods:{async getTags(){const s=await $({page:1,limit:-1,sources:"download"}),e=[];s.records.forEach(t=>{e.find(n=>n.name===t.name&&n.value===t.value)||e.push(t)}),this.tags=e},deleteTag(s,e){_(s.id,e.id).then(()=>{s.tags=s.tags.filter(t=>t.id!==e.id),this.getTags()}).catch(t=>this.$snack.error(`Error: ${t}`))},updateTag(s,e){h(s.id,e).then(t=>{const a=s.tags.findIndex(n=>n.id===t.id);s.tags.splice(a,1,t),this.getTags(),this.$snack.success("Tag updated")}).catch(t=>this.$snack.error(`Error: ${t}`))},addTag(s,e){f(s.id,e).then(t=>{s.tags.push(t),this.getTags()}).catch(t=>this.$snack.error(`Error: ${t}`))},async getDownloads(){this.loading=!0;const s=await v({page:this.currentPage,limit:this.itemsPerPage,query:this.search,sources:this.selectedSources,sortBy:this.sortBy,sortOrder:this.sortDesc?"desc":"asc",tags:this.selectedTags});this.items=s.records,this.currentPage=s.page,this.totalPages=s.total_pages,this.totalItems=s.total,this.loading=!1},downloadFile(s){b(s.id)},async refreshDownloads(){this.debouncedGetDownloads()},handleFileImport(){this.isSelecting=!0,window.addEventListener("focus",()=>{this.isSelecting=!1},{once:!0}),this.$refs.uploader.click()},async onFileChanged(s){this.selectedFile=s.target.files[0];const e=new FormData;e.append("file",this.selectedFile),await w(e),this.$snack.success("Upload complete"),this.debouncedGetDownloads()},handlePageChange(s){this.currentPage=s,this.debouncedGetDownloads()},handleOptionsChange(s){this.currentPage=s.page,this.itemsPerPage=s.itemsPerPage,s.sortBy.length>0?(this.sortBy=s.sortBy[0],this.sortDesc=s.sortDesc[0]):(this.sortBy="updated_at",this.sortDesc=!0),this.debouncedGetDownloads()},formatBytes(s,e){if(s===0)return"0 Bytes";const t=1024,a=e||2,n=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.floor(Math.log(s)/Math.log(t));return`${parseFloat((s/t**o).toFixed(a))} ${n[o]}`}}};var I=function(){var e=this,t=e._self._c;return t("div",[t(p,{attrs:{breads:e.breads,"show-create":!1,"show-refresh":!0,"show-delete":!1},on:{refresh:e.refreshDownloads}},[t("template",{slot:"extra-stuff"},[t(g,{attrs:{icon:"fa-upload",text:"Upload"},on:{click:e.handleFileImport}}),t("input",{ref:"uploader",staticClass:"d-none",attrs:{type:"file","aria-label":"uploader"},on:{change:e.onFileChanged}})],1)],2),t("div",{staticStyle:{display:"flex","flex-direction":"row","flex-wrap":"wrap"}},[t(l,{staticClass:"mr-2 pa-2",staticStyle:{"flex-basis":"250px"},attrs:{elevation:"2",outlined:""}},[t(F,{staticClass:"mb-6",attrs:{multiple:""}},[t(u,{attrs:{title:"Search",label:"Search"},model:{value:e.search,callback:function(a){e.search=a},expression:"search"}}),t(i,{attrs:{title:"Source",label:"label","item-key":"value","item-value":"value",items:e.sources},model:{value:e.selectedSources,callback:function(a){e.selectedSources=a},expression:"selectedSources"}}),t(i,{attrs:{title:"Tags",label:"label","item-key":"id","item-value":"label",items:e.tags,"empty-default":!0},model:{value:e.selectedTags,callback:function(a){e.selectedTags=a},expression:"selectedTags"}})],1)],1),t(l,{staticStyle:{flex:"1","min-width":"0"},attrs:{elevation:"2",outlined:""}},[t(C,{attrs:{length:e.totalPages,"total-visible":10},on:{input:e.handlePageChange},model:{value:e.currentPage,callback:function(a){e.currentPage=a},expression:"currentPage"}}),t(G,{attrs:{headers:e.headers,items:e.items,"item-key":"id","sort-by":e.sortBy,"sort-desc":e.sortDesc,"server-items-length":e.totalItems,"footer-props":{"items-per-page-options":[10,25,50,100]},"items-per-page":e.itemsPerPage,loading:e.loading,page:e.currentPage},on:{"update:itemsPerPage":function(a){e.itemsPerPage=a},"update:items-per-page":function(a){e.itemsPerPage=a},"update:options":e.handleOptionsChange},scopedSlots:e._u([{key:"item.updated_at",fn:function({item:a}){return[t(r,{attrs:{timestamp:a.updated_at}})]}},{key:"item.created_at",fn:function({item:a}){return[t(r,{attrs:{timestamp:a.created_at}})]}},{key:"item.size",fn:function({item:a}){return[t("span",[e._v(e._s(e.formatBytes(a.size)))])]}},{key:"item.tags",fn:function({item:a}){return[t(d,{attrs:{tags:a.tags},on:{"update-tag":function(n){return e.updateTag(a,...arguments)},"delete-tag":function(n){return e.deleteTag(a,...arguments)},"new-tag":function(n){return e.addTag(a,...arguments)}}})]}},{key:"item.actions",fn:function({item:a}){return[t(y,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:n,attrs:o}){return[t(x,e._g(e._b({attrs:{text:"",icon:"","x-small":""}},"v-btn",o,!1),n),[t(c,[e._v("fa-ellipsis-v")])],1)]}}],null,!0)},[t(P,{staticClass:"ml-2 mr-2"},[t(T),t(D,{attrs:{link:""},on:{click:function(n){return e.downloadFile(a)}}},[t(k,[t(c,[e._v("fa-download")]),e._v(" Download ")],1)],1)],1)],1)]}}])})],1)],1)],1)},z=[],A=m(E,I,z,!1,null,null,null,null);const ee=A.exports;export{ee as default};
